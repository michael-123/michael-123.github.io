<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>TRVMP - Die Tabelle</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script>
var TOKEN = new URL(window.location.href).searchParams.get('token')
var SERVICE_URL = atob(TOKEN)

function get(url, callback) {
    $.ajax({
        url: url,
        dataType: 'text',
        success: function (data) {
		callback(JSON.parse(data))
        },
        error: function () {
            console.log('Failed!')
        }
    });
}

function applyTable(data) {
    $("#die-tabelle table").remove();
    var tableData = data.table
    
    var table = $('<table>').attr('class', 'table table-striped');
    var tableBody = $('<tbody>')
        .attr('class', 'table-body')
        .appendTo(table);
    table.appendTo($('#die-tabelle'));

    $('<thead><tr><td>Rank</td><td>Player</td><td>Games</td><td>Goals</td><td>ELO</td></tr></thead>')
	.appendTo(table);

    for (var i = 0; i <= Object.keys(tableData).length; i++) {
        var e = tableData[i];
        var row = $('<tr>');
    	$('<td>' + e.rank + '</td>' + 
		'<td>' + e.player.user.name + '</td>' + 
		'<td>' + e.amount_games + '</td>' +
		'<td>' + e.goals_scored + ':' + e.goals_conceded + '</td>' +
		'<td>' + e.elo + '</td>').appendTo(row);
        row.appendTo(tableBody);
    } 
}

function getUrlAppendix(userName, fromDate, toDate) {
    urlAppendix = userName
    if (fromDate != null) {
        urlAppendix = urlAppendix + '/from/' + fromDate
        if (toDate != null) {  // toDate only if fromDate is given
            urlAppendix = urlAppendix + '/to/' + toDate
        }
    }
    return urlAppendix
}

function decryptToken(token) {

}

function applyData() {
    get(SERVICE_URL + '/table', applyTable)
}

function getMonthAppendix() {
	var date = new Date();
	var appendix = 'from_month=' + (date.getMonth() + 1) +
		'&from_year=' + date.getFullYear() +
		'&to_month='+(date.getMonth() + 2) +
		'&to_year=' + date.getFullYear()
	console.log(appendix)
	return appendix
}

$(document).ready(function () {
	$('#all-table').click(function(){
		get(SERVICE_URL + '/table', applyTable)
	});
	$('#month-table').click(function(){
		var appendix = getMonthAppendix()
		get(SERVICE_URL + '/table?' + appendix, applyTable)
	});
    applyData()
});
	</script>
    </head>
    <body>
        <div class="container">
            <header class="page-header">
                <h1>TRVMP</h1>
		<nav class="row">
			<div class="col-sm-8">
				<button id="all-table">All</button>
				<button id="month-table">This Month</button>
			</div>
		</nav>
            </header>
            <main>
                <div class="row">
                    <div>
                        <div class="col-sm-12">
                            <h2>Die Tabelle</h2>
                            <div id="die-tabelle"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <ul class="list-group" id="latest-plays"></ul>
                </div>
            </main>
            <footer>
            </footer>
        </div> 
    </body>
</html>
